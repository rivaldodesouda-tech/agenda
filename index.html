<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda Profissional</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Cabe√ßalho Principal -->
        <header class="no-print">
            <div class="header-content">
                <h1 id="headerTitle">DEZEMBRO 2025</h1>
                <div class="nav-controls">
                    <button onclick="changeDate(-1)">‚óÄ</button>
                    <button onclick="goToToday()">HOJE</button>
                    <button onclick="changeDate(1)">‚ñ∂</button>
                </div>
            </div>
            <div class="view-controls">
                <button id="weekViewBtn" onclick="switchView('week')" class="active">üìÖ Semanal</button>
                <button id="monthViewBtn" onclick="switchView('month')">üìÜ Mensal</button>
                <button id="printWeekBtn" onclick="printWeekly()" class="print-btn">üñ®Ô∏è Imprimir Semana</button>
                <button id="printMonthBtn" onclick="printMonthly()" class="print-btn" style="display:none;">üñ®Ô∏è Imprimir M√™s</button>
            </div>
        </header>

        <!-- Cabe√ßalho de Impress√£o Mensal -->
        <div id="monthPrintHeader" class="print-only month-print-header">
            <h1 id="monthPrintTitle">DEZEMBRO 2025</h1>
        </div>

        <!-- Conte√∫do Principal -->
        <main>
            <!-- Vis√£o Semanal -->
            <div id="weekView" class="view-container active">
                <div id="weekGrid" class="week-grid">
                    <!-- Cards dos dias ser√£o inseridos aqui -->
                </div>
            </div>

            <!-- Vis√£o Mensal -->
            <div id="monthView" class="view-container">
                <div class="month-calendar">
                    <div class="month-day-headers">
                        <div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div class="weekend">S√ÅB</div><div class="weekend">DOM</div>
                    </div>
                    <div id="monthGrid" class="month-grid">
                        <!-- C√©lulas do m√™s ser√£o inseridas aqui -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal de Edi√ß√£o Di√°ria -->
        <div id="editModal" class="modal no-print">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalDateTitle">22/12/2025 - Segunda-feira</h2>
                    <div class="modal-actions">
                        <button onclick="printDaily()" class="print-btn-small">üñ®Ô∏è</button>
                        <button onclick="closeModal()" class="close-btn">&times;</button>
                    </div>
                </div>
                <div class="format-bar">
                    <button onclick="formatText('bold')" title="Negrito"><b>B</b></button>
                    <button onclick="formatText('foreColor', '#ff0000')" style="color:red">A</button>
                    <button onclick="formatText('foreColor', '#008000')" style="color:green">A</button>
                    <button onclick="formatText('foreColor', '#0000ff')" style="color:blue">A</button>
                    <button onclick="formatText('hiliteColor', '#ffff00')" style="background:yellow">A</button>
                    <button onclick="formatText('hiliteColor', '#00ff00')" style="background:lime">A</button>
                    <button onclick="formatText('hiliteColor', '#ffcccc')" style="background:#ffcccc">A</button>
                    <button onclick="formatText('removeFormat')">Clear</button>
                </div>
                <div id="notebook" class="notebook">
                    <!-- 30 linhas de edi√ß√£o -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado da Aplica√ß√£o
        const appState = {
            currentDate: new Date(),
            view: 'week',
            data: JSON.parse(localStorage.getItem('agendaData') || '{}'),
            selectedDate: null,
            selectedLineIndex: null
        };

        // Inicializa√ß√£o
        function init() {
            render();
            // Salvar automaticamente ao fechar ou mudar
            window.addEventListener('beforeunload', () => saveToStorage());
        }

        function saveToStorage() {
            localStorage.setItem('agendaData', JSON.stringify(appState.data));
        }

        function switchView(view) {
            appState.view = view;
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.view-controls button').forEach(el => el.classList.remove('active'));
            
            if (view === 'week') {
                document.getElementById('weekView').classList.add('active');
                document.getElementById('weekViewBtn').classList.add('active');
                document.getElementById('printWeekBtn').style.display = 'block';
                document.getElementById('printMonthBtn').style.display = 'none';
            } else {
                document.getElementById('monthView').classList.add('active');
                document.getElementById('monthViewBtn').classList.add('active');
                document.getElementById('printWeekBtn').style.display = 'none';
                document.getElementById('printMonthBtn').style.display = 'block';
            }
            render();
        }

        function changeDate(days) {
            if (appState.view === 'week') {
                appState.currentDate.setDate(appState.currentDate.getDate() + (days * 7));
            } else {
                appState.currentDate.setMonth(appState.currentDate.getMonth() + days);
            }
            render();
        }

        function goToToday() {
            appState.currentDate = new Date();
            render();
        }

        function render() {
            if (appState.view === 'week') renderWeekView();
            else renderMonthView();
            saveToStorage();
        }

        function renderWeekView() {
            const grid = document.getElementById('weekGrid');
            grid.innerHTML = '';
            
            const startOfWeek = new Date(appState.currentDate);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
            startOfWeek.setDate(diff);

            const monthTitle = startOfWeek.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
            document.getElementById('headerTitle').textContent = monthTitle;

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                grid.appendChild(createDayCard(date));
            }
        }

        function createDayCard(date) {
            const dateStr = date.toISOString().split('T')[0];
            const dayData = appState.data[dateStr] || { lines: Array(30).fill({text:''}) };
            
            const card = document.createElement('div');
            card.className = 'day-card-grid';
            
            const header = document.createElement('div');
            header.className = 'day-card-header';
            const dayName = date.toLocaleDateString('pt-BR', { weekday: 'long' });
            header.innerHTML = `<strong>${date.getDate()}</strong> - ${dayName}`;
            
            const printHeader = document.createElement('div');
            printHeader.className = 'print-only day-print-header-weekly';
            printHeader.innerHTML = `<strong>${date.getDate()}/${date.getMonth()+1}</strong><br>${dayName}`;

            const content = document.createElement('div');
            content.className = 'day-card-content';
            
            const printCols = document.createElement('div');
            printCols.className = 'print-only day-print-columns';
            const pCol1 = document.createElement('div'); pCol1.className = 'print-col';
            printCols.appendChild(pCol1);

            let hasAnyContent = false;
            let contentLines = [];
            for (let i = 0; i < 30; i++) {
                const line = dayData.lines[i] || { text: '' };
                const hasContent = !!(line.text || line.html);
                if (hasContent) {
                    hasAnyContent = true;
                    contentLines.push({ index: i + 1, data: line });
                }
                
                // Tela: 10 linhas vis√≠veis
                const lineWrap = document.createElement('div');
                lineWrap.className = 'day-line-wrapper no-print' + (hasContent ? ' has-content' : ' empty-line');
                if (i >= 10) lineWrap.style.display = 'none';
                lineWrap.innerHTML = `<span class="line-number-preview" style="color:#bbb;">${i+1}.</span><div class="day-line-preview">${line.html || line.text || '&nbsp;'}</div>`;
                content.appendChild(lineWrap);
            }

            // Impress√£o Semanal: 30 linhas
            const totalChars = contentLines.reduce((acc, curr) => acc + (curr.data.text || curr.data.html || "").length, 0);
            let fontSize = 7;
            if (totalChars > 1500) fontSize = 4;
            else if (totalChars > 1000) fontSize = 5;
            else if (totalChars > 500) fontSize = 6;

            for (let j = 0; j < 30; j++) {
                const lineData = dayData.lines[j] || { text: '' };
                const hasLineContent = !!(lineData.text || lineData.html);
                const pWrap = document.createElement('div');
                pWrap.className = 'day-line-wrapper print-line' + (hasLineContent ? ' has-content' : ' empty-line');
                pWrap.style.cssText = `border-bottom: 0.1px solid #eee; display: flex; align-items: flex-start; padding: 0.5px 0; font-size: ${fontSize}px;`;
                pWrap.innerHTML = `<span class="line-number-preview" style="font-size: ${fontSize*0.8}px; width: 12px; flex-shrink: 0;">${j+1}.</span><div class="day-line-preview" style="flex: 1; word-break: break-all;">${lineData.html || lineData.text || '&nbsp;'}</div>`;
                pCol1.appendChild(pWrap);
            }
            content.appendChild(printCols);

            card.appendChild(header);
            card.appendChild(printHeader);
            card.appendChild(content);
            card.onclick = () => openDayEdit(date);
            return card;
        }

        function renderMonthView() {
            const grid = document.getElementById('monthGrid');
            grid.innerHTML = '';
            const date = new Date(appState.currentDate);
            date.setDate(1);
            const monthTitle = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
            document.getElementById('headerTitle').textContent = monthTitle;
            document.getElementById('monthPrintTitle').textContent = monthTitle;

            const firstDay = (date.getDay() + 6) % 7;
            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'month-day-cell empty';
                grid.appendChild(empty);
            }

            for (let i = 1; i <= lastDay; i++) {
                const cellDate = new Date(date.getFullYear(), date.getMonth(), i);
                grid.appendChild(createMonthCell(cellDate));
            }
        }

        function createMonthCell(date) {
            const dateStr = date.toISOString().split('T')[0];
            const dayData = appState.data[dateStr];
            const cell = document.createElement('div');
            cell.className = 'month-day-cell';
            if (date.getDay() === 0 || date.getDay() === 6) cell.classList.add('weekend');
            
            let html = `<div class="month-day-num-container"><span class="month-day-num">${date.getDate()}</span></div>`;
            html += '<div class="month-cell-content">';
            
            if (dayData && dayData.lines) {
                const contentLines = [];
                dayData.lines.forEach((l, idx) => { if (l && (l.text || l.html)) contentLines.push({ index: idx + 1, data: l }); });

                html += '<div class="month-content-wrapper" style="display: table; width: 100%; height: 100%; table-layout: fixed; border-collapse: collapse;">';
                const cols = ['', '', ''];
                const totalChars = contentLines.reduce((acc, curr) => acc + (curr.data.text || curr.data.html || "").length, 0);
                let fontSize = 6;
                if (totalChars > 1000) fontSize = 2.5;
                else if (totalChars > 700) fontSize = 3;
                else if (totalChars > 500) fontSize = 3.5;
                else if (totalChars > 300) fontSize = 4.5;
                else if (totalChars > 150) fontSize = 5.5;

                for (let lineIdx = 1; lineIdx <= 30; lineIdx++) {
                    const lineData = dayData.lines[lineIdx-1];
                    const hasContent = lineData && (lineData.text || lineData.html);
                    const lineClass = hasContent ? 'month-line-rich has-content' : 'month-line-rich empty-line';
                    const cleanHtml = hasContent ? (lineData.html || lineData.text).replace(/font-size:[^;"]+;?/g, '') : '&nbsp;';
                    const lineHtml = `<div class="${lineClass}" style="font-size:${fontSize}px; border-bottom: 0.05px solid #eee; line-height: 1; word-break: break-all; white-space: normal; display: flex; align-items: flex-start; padding: 0.2px 0; min-height: 1.1em;"><span class="line-num-label" style="color:#ccc; font-size: 0.7em; width: 7px; flex-shrink: 0; margin-right: 0.5px;">${lineIdx}.</span><div class="line-text-content" style="flex: 1; min-width: 0; overflow: visible;">${cleanHtml}</div></div>`;
                    
                    if (lineIdx <= 10) cols[0] += lineHtml;
                    else if (lineIdx <= 20) cols[1] += lineHtml;
                    else cols[2] += lineHtml;
                }
                html += `<div class="month-col col-1" style="display: table-cell; width: 33.33%; vertical-align: top;">${cols[0]}</div>`;
                html += `<div class="month-col col-2" style="display: table-cell; width: 33.33%; vertical-align: top; border-left: 0.1px solid #eee;">${cols[1]}</div>`;
                html += `<div class="month-col col-3" style="display: table-cell; width: 33.33%; vertical-align: top; border-left: 0.1px solid #eee;">${cols[2]}</div>`;
                html += '</div>';
            }
            html += '</div>';
            cell.innerHTML = html;
            cell.onclick = () => openDayEdit(date);
            return cell;
        }

        function openDayEdit(date) {
            appState.selectedDate = date;
            const dateStr = date.toISOString().split('T')[0];
            const dayData = appState.data[dateStr] || { lines: Array(30).fill({text:''}) };
            
            document.getElementById('modalDateTitle').textContent = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', weekday: 'long' });
            const notebook = document.getElementById('notebook');
            notebook.innerHTML = '';

            for (let i = 0; i < 30; i++) {
                const wrap = document.createElement('div');
                wrap.className = 'notebook-line-wrapper';
                const lineData = dayData.lines[i] || { text: '' };
                
                const line = document.createElement('div');
                line.className = 'notebook-line';
                line.contentEditable = true;
                line.setAttribute('data-index', i);
                line.innerHTML = lineData.html || lineData.text || '';
                
                line.oninput = function() { 
                    updateLine(this.getAttribute('data-index'), this);
                    adjustFontSize(this, 24);
                };
                line.onfocus = function() { appState.selectedLineIndex = parseInt(this.getAttribute('data-index')); };
                
                line.onkeydown = function(e) {
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        const nextIdx = parseInt(this.getAttribute('data-index')) + 1;
                        if (nextIdx < 30) {
                            const nextEl = document.querySelector(`[data-index="${nextIdx}"]`);
                            if (nextEl) nextEl.focus();
                        }
                    }
                };
                
                wrap.innerHTML = `<div class="line-number">${i+1}.</div>`;
                wrap.appendChild(line);
                notebook.appendChild(wrap);
                if (line.innerHTML) setTimeout(() => adjustFontSize(line, 24), 0);
            }
            document.getElementById('editModal').style.display = 'flex';
        }

        function updateLine(index, element) {
            const dateStr = appState.selectedDate.toISOString().split('T')[0];
            if (!appState.data[dateStr]) appState.data[dateStr] = { lines: Array(30).fill({text:''}) };
            appState.data[dateStr].lines[index] = { text: element.innerText, html: element.innerHTML };
            saveToStorage();
        }

        function adjustFontSize(el, max) {
            let size = max;
            el.style.fontSize = size + 'px';
            while (el.scrollHeight > el.offsetHeight && size > 8) {
                size--;
                el.style.fontSize = size + 'px';
            }
        }

        function formatText(cmd, val) {
            document.execCommand(cmd, false, val);
            const active = document.activeElement;
            if (active && active.classList.contains('notebook-line')) {
                updateLine(active.getAttribute('data-index'), active);
            }
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            render();
        }

        function printWeekly() {
            document.body.className = 'print-weekly-landscape';
            window.print();
            document.body.className = '';
        }

        function printMonthly() {
            document.body.className = 'print-monthly-landscape';
            window.print();
            document.body.className = '';
        }

        function printDaily() {
            document.body.className = 'print-daily-portrait';
            window.print();
            document.body.className = '';
        }

        init();
    </script>
</body>
</html>
